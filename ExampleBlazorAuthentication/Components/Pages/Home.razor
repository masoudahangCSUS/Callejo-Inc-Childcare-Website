@page "/"
@using Common.View
@using ExampleBlazorAuthentication.Service
@rendermode InteractiveServer
@inject LoginService LoginService
@inject IJSRuntime JS
@inject NavigationManager NavigationManager
@inject CustomAuthenticationStateProvider AuthenticationStateProvider

<script type="text/javascript">
    function setCookie(name, value, days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + (value || "") + expires + "; path=/";
    }
</script>

<h3>Login</h3>

<div>
    <label for="username">Username:</label>
    <input type="text" id="username" @bind="Username" />
</div>
<div>
    <label for="password">Password:</label>
    <input type="password" id="password" @bind="Password" />
</div>
<button @onclick="AuthenticateUser">Login</button>

@if (IsAuthenticated != null && IsAuthenticated.Value)
{
    <p>Login successful!</p>
}
else if (IsAuthenticated != null && !IsAuthenticated.Value)
{
    <p>Login failed.</p>
}

@code {
    private string Username { get; set; }
    private string Password { get; set; }
    private bool? IsAuthenticated { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        Username = "scallejo";
        Password = "SamTest";
    }

    private async Task AuthenticateUser()
    {

        // Call the async method and block until it completes
        APIResponse response = Task.Run(() => LoginService.LoginUser(Username, Password)).Result;

        if (response != null && response.Success)
        {
            await JS.InvokeVoidAsync("localStorage.setItem", "authToken", response.Token.ToString());
            await JS.InvokeVoidAsync("localStorage.setItem", "authUserName", Username);
            AuthenticationStateProvider.MarkUserAsAuthenticated(response.Token.ToString(), Username);
            IsAuthenticated = true;
            // Redirect to the Roles component
            NavigationManager.NavigateTo("/roles");
        }
        else
        {
            Console.WriteLine("Login failed.");
            IsAuthenticated = false;
        }

    }
}
